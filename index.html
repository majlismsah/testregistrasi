<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Kontak Darurat & Upload Dokumen</title>
  <script>
    async function handleSubmit(event) {
      event.preventDefault();

      const form = event.target;
      const kontakNama = form.kontak_nama.value.trim();
      const kontakHubungan = form.kontak_hubungan.value.trim();
      const kontakWa = form.kontak_wa.value.trim();

      // Validasi nomor WA: harus mulai dengan 62 dan minimal 11 digit
      if (!/^62\d{9,}$/.test(kontakWa)) {
        alert("No. WA harus dimulai dengan 62 dan minimal 11 digit angka.");
        return;
      }

      const fotoFile = form.foto.files[0];
      const ktpFile = form.ktp.files[0];

      if (!fotoFile || !ktpFile) {
        alert("Mohon upload kedua file: Foto & KTP.");
        return;
      }

      // Convert files to base64
      const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const fotoBase64 = await toBase64(fotoFile);
      const ktpBase64 = await toBase64(ktpFile);

      const data = {
        kontak_nama: kontakNama,
        kontak_hubungan: kontakHubungan,
        kontak_wa: kontakWa,
        foto_filename: fotoFile.name,
        foto_mimetype: fotoFile.type,
        foto_base64: fotoBase64,
        ktp_filename: ktpFile.name,
        ktp_mimetype: ktpFile.type,
        ktp_base64: ktpBase64
      };

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbxNtIitYMZrFeRTwAkmlr73Rr44ZEQ1QokT2-L8O2tmZmvitMu3psPaKSk8vNE0EKnpJQ/exec", {
          method: "POST",
          body: JSON.stringify(data),
          headers: {
            "Content-Type": "application/json"
          }
        });

        const text = await response.text();
        alert("Sukses: " + text);
        form.reset();
      } catch (error) {
        console.error("Upload gagal:", error);
        alert("Gagal mengirim data. Cek koneksi atau izin akses Web App.");
      }
    }
  </script>
</head>
<body class="p-4 font-sans">
  <h2>Kontak Darurat & Upload Dokumen</h2>
  <form onsubmit="handleSubmit(event)">
    <div>
      <label>Nama Kontak Darurat:</label><br>
      <input type="text" name="kontak_nama" required>
    </div>
    <div>
      <label>Hubungan:</label><br>
      <input type="text" name="kontak_hubungan" required>
    </div>
    <div>
      <label>No. WA Kontak Darurat (format: 628xxxxxxxxx):</label><br>
      <input type="text" name="kontak_wa" required>
    </div>
    <hr>
    <div>
      <label>Upload Foto Profil:</label><br>
      <input type="file" name="foto" accept="image/*" required>
    </div>
    <div>
      <label>Upload Foto KTP:</label><br>
      <input type="file" name="ktp" accept="image/*,.pdf" required>
    </div>
    <br>
    <button type="submit">Kirim</button>
  </form>
</body>
</html>
